<!DOCTYPE html>
<html>

<head>
    <title>Bike Report</title>
    <meta charset="UTF-8">
    <script src='//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js'></script>
    <link href='http://fonts.googleapis.com/css?family=Droid+Serif%7CCrimson+Text' rel='stylesheet' type='text/css'>

    <!--Main CSS-->
    <link rel='stylesheet' href='styles/bikeStyles.css' type='text/css' media='screen' /> 

    <style type='text/css'>    
        #content
        {
            position: absolute;
        }
        h4, h6
        {
            display: inline;
        }
        .summaryTable
        {
            width: 80%;
            margin: 0 auto;
        }   

        .summaryCell
        {
            width: 30%;
            text-align: center;
            /* Fallback for web browsers that don't support RGBa */
            background-color: rgb(255, 255, 255);
            /* RGBa with 0.6 opacity */
            background-color: rgba(255, 255, 255, 0.6);
            border-style: solid;
            border-width: 2px;
            border-color: rgb(255, 255, 255);            
            padding: 5px;
            -webkit-border-top-right-radius: 5px;
            -webkit-border-bottom-left-radius: 10px;
            -moz-border-radius-topright: 5px;
            -moz-border-radius-bottomleft: 10px;
            border-top-right-radius: 5px;
            border-bottom-left-radius: 10px;
        }

        #right
        {
            text-align: right;
        }

        #units2
        {
            font-size: 100%;
        }
    </style>

    <script>
        function tellIP(ip) {
            var ipXML, ipURL, userLocation;

            ipXML = new XMLHttpRequest();
            ipURL = "http://freegeoip.net/json/" + ip;

            ipXML.onreadystatechange = function () {
                if(ipXML.readyState === 4 && ipXML.status === 200) {
                    // Generates information about the user's location
                    userLocation = parseIP(ipXML.responseText);
                }
            }
            ipXML.open("GET", ipURL, true);
            ipXML.send();
        }

        // Get the User's IP Address
        $(document).ready(function () {
            $.get('http://jsonip.com', function (res) {
                tellIP(res.ip);
            });
        });

        function ipReport(ipURL,frm) {
            var units;

            units = frm.ipUnits.value;
            relocate(ipURL + "&units=" + units);
        }

        function pickDropDown(frm, placeArr, type, units)
        {
                if(type == "major")
                {
                    dropDownValue = cityDropDown.value;
                }
                if(type == "explore")
                {
                    dropDownValue = interestingDropDown.value;
                }
                // foreach over an array of predefined city data; if found, populate the results and move on; else, use the city name in a search-mode result
                for(i = 0; i < placeArr.length; i++)
                {
                    if(dropDownValue.toLowerCase() == placeArr[i][2].toLowerCase())
                    {
                        lat = placeArr[i][0];
                        lng = placeArr[i][1];
                        cityName = placeArr[i][2];
                        locality = placeArr[i][3];
                        country = placeArr[i][4];
                        
                        relocate("bikeReport.php?cityName=" + cityName + "&lat=" + lat + "&lng=" + lng + "&locality=" + locality + "&country=" + country + "&units=" + units);
                    }
                    else
                    {
                        // As a backup.
                        cityName = dropDownValue;
                    }
                }
                i = 0;
        }

        function parseIP(res) {
            // Parse json object with user location data
            var jsonArr, ip, ipCityName, ipCountry, ipLat, ipLng, ipLocality, units, ipOutput;

            jsonArr = JSON.parse(res);
            ip = jsonArr.ip;
            ipCityName = jsonArr.city;
            ipCountry = jsonArr.country_name;
            ipLat = jsonArr.latitude;
            ipLng = jsonArr.longitude;
            ipLocality = jsonArr.region_name;
            //units = "CA";  // Hard-coded for now
            units = document.getElementsByName('units2')[0].value;
            //units = document.getElementById('units2').value;
            //units = this.form.units.value; // doesn't work

            // enclose ipOutput in summarCell class div
            //ipOutput = "<br/><div class='summaryCell'>";

            ipOutput = "<h6>Based upon your IP address (" + ip + "), you appear to be in " + ipCityName + ", " + ipCountry + ".</h6>";//  Would you like to get the report for " + ipCityName + "?<br/><br/></div>";

            ipArray = [ipCityName, ipLocality, ipCountry, ipLat, ipLng];

            ipOutput += "<button type='button' id='checkButtonIP' onclick='ipArray.push(&quot;" + units + "&quot;); getCityData(ipArray)'>Get Report for " + ipCityName + "</button>";


            // Prompt the user to use IP geolocation to generate a report
            document.getElementById("userIP").innerHTML = ipOutput; 
        }

        function getCityData(frm) {
            var majorCities, units, output, cityXML, cityURL, cityURL1, cityURL2, cityName, candidates, lat, lng, locality, country, i;

            // If frm is an array, then it contains the specifics of a place from IP tracing.  Just go straight to the report page.
            if(frm instanceof Array)
            {
                relocate("bikeReport.php?cityName=" + frm[0] + "&lat=" + frm[3] + "&lng=" + frm[4] + "&locality=" + frm[1] + "&country=" + frm[2] + "&units=" + frm[5]);
            }

            // Default cities data: lat, lng, cityName, locality, country
            majorCities = [
                [43.653226, -79.3831843, "Toronto", "Ontario", "Canada"],
                [40.7127837, -74.0059413, "New York", "New York", "United States"],
                [45.5234515, -122.6762071, "Portland", "Oregon", "United States"],

                [51.5072, -0.08, "London", "England", "United Kingdom"],
                [48.8567,  2.3508, "Paris", "", "France"],
                [55.7500,  37.6167, "Moscow", "", "Russia"],
                [52.518623,  13.376198, "Berlin", "", "Germany"],
                [52.3667,  4.9000, "Amsterdam", "", "The Netherlands"],

                [-33.865143,  151.209900, "Sydney", "", "Australia"],

                [30.0500,  31.2333, "Cairo", "", "Egypt"],

                [35.6895,  139.6917, "Tokyo", "", "Japan"],
                [31.2222,  121.4580, "Shanghai", "", "China"],
                [22.2670, 114.1880, "Hong Kong", "Hong Kong Island", "China"]
            ];

            explorePlaces = [
                [-77.8500, 166.6667, "McMurdo Station", "", "Antarctica"],
                [40.8033, -76.3417, "Centralia", "Pennsylvania", "United States"],
                [51.4056, 30.0569, "Prypiat", "", "Ukraine"],
                [28.4889, -80.5778, "Cape Canaveral", "Florida", "United States"]
            ];

            units = frm.units2.value;
            output = "";

            // Validation: If no search was made, and nothing picked from the drop-downs, alert the user.
            if(frm.cityDropDown.value === "default" && frm.cityInput.value === "" && frm.interestingDropDown.value === "default")
            {
                window.alert("Please either select a city from either drop-down menu or search for a city.");
                return;
            }

            // Cannot have the user selecting from both drop-downs at once
            if(frm.cityDropDown.value != "default" && frm.interestingDropDown.value != "default")
            {
                window.alert("Please choose either a major city or an interesting place to explore, not both at the same time.");
                return;
            }

            // if a drop-down is choosen, but ALSO a search value is picked.
            if( (frm.cityDropDown.value != "default" && frm.cityInput.value !== "") || (frm.interestingDropDown.value != "default" && frm.cityInput.value !== "") )
            {
                window.alert("Please choose a location from a drop-down menu or search for a place, but not both at once.");
                return;
            }

            // At this point, we should have exactly one option entered.  Parse the form data

            // Do a search
            if(frm.cityDropDown.value == "default" && frm.interestingDropDown.value == "default")
            {

                // Perform Google geolocation
                cityXML = new XMLHttpRequest();
                cityURL1 = "http://maps.googleapis.com/maps/api/geocode/json?address=";
                cityName = frm.cityInput.value.trim();
                cityURL2 = "&sensor=false";
                cityURL = cityURL1 + cityName + cityURL2;

                frm.cityInput.value = "";

                cityXML.onreadystatechange=function() 
                {
                    if (cityXML.readyState == 4 && cityXML.status == 200) 
                    {
                        // Generates a list of cities with the name the user input
                        candidates = parseCity(cityXML.responseText, cityName, units);
                    }
                }
                cityXML.open("GET", cityURL, true);
                cityXML.send();
            }
            //an interesting place was choosen 
            else if(frm.interestingDropDown.value !== "default") 
            {  
                // Functionalize the drop-down place search so as not to duplicate code.
                pickDropDown(frm, explorePlaces, "explore", units)
            }

            // Else, do a major city search
            else
            {
                pickDropDown(frm, majorCities, "major", units)
            }
        }

        function parseCity(response, cityName, units) {
            // Parse response data and glean location data.  Accept only results that are valid cities and not place-names similar to cityName
            var jsonArr, i, j, output, lat, lng, cityFlag, cityCount, possibleCities, candidate;
            jsonArr = JSON.parse(response);
            output = "";
            lat = "";
            lng = "";
            cityFlag = 0;
            cityCount = 0;

            /* 
                Array for storing candiate cities for the user to select from:
                [0]: latitude
                [1]: longitude
                [2]: city name      (e.g. Toronto)
                [3]: city locality  (e.g. Ontario)
                [4]: Country        (e.g. Canada)
            */ 
            possibleCities = [];

            for(i = 0; i < jsonArr.results.length; i++)
            {
                // possibleCities.push(candidate);
                candidate = [];
                candidate[0] = jsonArr.results[i].geometry.location.lat;
                candidate[1] = jsonArr.results[i].geometry.location.lng;

                output += "<table>";
                for(j = 0; j < jsonArr.results[i].address_components.length; j++)
                {
                    if(jsonArr.results[i].address_components[j].types[0] == "locality")
                    {
                        // Not all localities are proper cities.  Some are "routes", etc..  Filter these out.
                        if(jsonArr.results[i].address_components[j].long_name.toLowerCase() == cityName.toLowerCase())
                        {
                            candidate[2] = jsonArr.results[i].address_components[j].long_name;
                            output += "<td>";
                            output += "<tr><td><b>City: </b></td><td>" + candidate[2] + "</td></tr>";
                            cityFlag = 1;
                        }
                        // if formatted_address.toLower() includes the name.toLower(), then its likely a good guess
                        if (jsonArr.results[i].formatted_address.toLowerCase().indexOf(cityName.toLowerCase()) >= 0)
                        {
                            candidate[2] = jsonArr.results[i].address_components[j].long_name;
                            output += "<td>";
                            output += "<tr><td><b>City: </b></td><td>" + candidate[2] + "</td></tr>";
                            cityFlag = 1;
                        }
                    }  
                    if(jsonArr.results[i].address_components[j].types[0] == "country" && cityFlag == 1)
                    {
                        candidate[4] = jsonArr.results[i].address_components[j].long_name;
                        output += "<tr><td><b>Country: </b></td><td>" + candidate[4] + "</td></tr>";
                    }
                    if(jsonArr.results[i].address_components[j].types[0] == "administrative_area_level_1" && cityFlag == 1)
                    {
                        candidate[3] = jsonArr.results[i].address_components[2].long_name;
                        output += "<tr><td><b>State/Province/Locality:</b></td><td> " + candidate[3] + "</td></tr>";
                    }
                }
                j = 0;

                if(cityFlag == 1)
                {
                    output += "<tr><td><b>Co-ordinates: </b></tr><br/>" + "<td><b>latitude</b> " + candidate[0] + " <b>by longitude</b> " + candidate[1] + "</td></tr><br/><br/>";

                    output += "</table>";
                    cityCount++;
                }
                else
                {
                    output += "</table>";
                }

                if( (typeof(candidate[0]) != 'undefined') || (typeof(candidate[1]) != 'undefined') || ((typeof candidate[2]) != 'undefined') || ((typeof candidate[3]) != 'undefined') || ((typeof candidate[4]) != 'undefined') )
                {
                    possibleCities.push(candidate);
                }
                cityFlag = 0;
            }
            output += "<br/><b>Number of cities with this name found:</b> " + cityCount + "<br/>";

            // TESTING
            //report(output);

            didYouMean(possibleCities, units);

            return possibleCities;
        }

        function report(output) {
            // Actually write the output string to the document
            document.getElementById("report").innerHTML = output;    
        }

        function relocate(url) {
            window.location = url;
        }

        function didYouMean(didYouMeanCities, units) {
            // Returns a single user-choosen city's data, given an array of cities.
            var validCityFlag, didYouMeanOutput, i, units;

            // ADJUST
            //units = "CA";

            validCityFlag = 0;
            didYouMeanOutput = "<br/><div class='summaryCell'>";
            didYouMeanOutput += "<p>Did you mean...?</p>";
            didYouMeanOutput += "<p>";
            for(i = 0; i < didYouMeanCities.length; i++)
            {
                if(typeof(didYouMeanCities[i][2]) != 'undefined')
                {
                    validCityFlag = 1;
                    didYouMeanOutput += "<a href='bikeReport.php?cityName=" + didYouMeanCities[i][2];
                    didYouMeanOutput += "&lat=" + didYouMeanCities[i][0];
                    didYouMeanOutput += "&lng=" + didYouMeanCities[i][1];
                    didYouMeanOutput += "&locality=" + didYouMeanCities[i][3];
                    didYouMeanOutput += "&country=" + didYouMeanCities[i][4];
                    didYouMeanOutput += "&units=" + units + "'>";

                    if(didYouMeanCities[i][2])
                    {
                        didYouMeanOutput += didYouMeanCities[i][2] + ", ";
                    }
                    if(didYouMeanCities[i][3])
                    {
                        didYouMeanOutput += didYouMeanCities[i][3] + ", ";
                    }
                    if(didYouMeanCities[i][4])
                    {
                        didYouMeanOutput += didYouMeanCities[i][4];
                    }

                    didYouMeanOutput += "</a><br/><br/>"; 
                }
            }
            didYouMeanOutput += "</p></div>";
            if(validCityFlag == 1)
            {
                report(didYouMeanOutput);
            }
            else
            {
                report("<div class='summaryCell'>Sorry, no results found for that name</div>");
            }
        }
    </script>

</head>

<body>

<div id='container'>
    <div id='header'>
        <h1>Bike Report: is it a good day to ride my bike?</h1>
    </div>
    <div id='navigation'></div>

    <div id='content'>
        <div class='summaryTable'>
            <div class='summaryRow' style='text-align: center;'>
                    <br/>
                    <h4>Bike Report provides weather, forecast and analysis of cycling conditions in whatever area you specify.</h4>
            </div><!--summaryRow-->
        </div><!--summaryTable-->
        <br/>
        <div id='newFormBox'>
            <form>
                <div class='summaryTable'>
                    <div class='summaryRow'>
                        <div id='left'>
                            <div class='inputCell'>
                                <select name="units2" id="units2">
                                    <option value="CA">Metric   (km/C)</option>
                                    <option value="US">Imperial (mi/F)</option>
                                    <option value="UK">Mixed    (mi/C)</option>
                                </select>  <h4>Units</h4>
                            <!--inputCell--></div>
                        </div><!--left-->

                        <div id='right'>
                            <span id='userIP2'>
                                <div id="userIP"></div>
                            </span>
                        </div><!--right-->
                    </div><!--units, IP output-->
                </div><!--summaryTable-->
                <br/>
                <div class='summaryTable'>
                    <div class='summaryRow'>
                        <div class='summaryCell'>
                            <label for='cityDropDown'><h2>Pick a City</h2></label>
                            
                            <select name="cityDropDown" id="cityDropDown">
                                <option value="default">Choose...</option>
                                <option value="toronto">Toronto</option>
                                <option value="new york">New York</option>
                                <option value="portland">Portland</option>

                                <option value="london">London</option>
                                <option value="paris">Paris</option>
                                <option value="moscow">Moscow</option>
                                <option value="Berlin">Berlin</option>
                                <option value="amsterdam">Amsterdam</option>

                                <option value="sydney">Sydney</option>

                                <option value="cairo">Cairo</option>

                                <option value="Tokyo">Tokyo</option>
                                <option value="hong kong">Hong Kong</option>
                                <option value="shanghai">Shanghai</option>
                            </select>
                        </div><!--Pick a City-->

                        <div class='spacer'>
                            <h4>OR</h4>
                        </div><!--OR1-->

                        <div class='summaryCell'>
                                <label for='cityInput'><h2>Search</h2></label>
                                <input type="text" size="10" name="cityInput" id="cityInput2"><br/>
                        </div><!--Search-->

                        <div class='spacer'>
                            <h4>OR</h4>
                        </div><!--OR2-->

                        <div class='summaryCell'>
                            <label for='interestingDropDown'><h2>Explore</h2></label>
                            <select name="interestingDropDown" id="interestingDropDown">
                                <option value="default">Choose...</option>
                                <option value="mcmurdo station">McMurdo, Antarctica</option>
                                <option value="centralia">Centralia, PA</option>
                                <option value="prypiat">Prypiat, Ukraine</option>
                                <option value="cape canaveral">Cape Canaveral</option>
                            </select>
                        </div><!--Interesting Places-->
                    </div><!--Three boxes-->
                </div><!--summaryTable-->

                <div class='summaryTable'>
                    <div class='summaryRow'>
                        <div class='summaryTitleCell' style='text-align: center;'>
                            <br/>
                            <button type="button" class="getReportButton" id="checkButton2" onclick="getCityData(this.form)">Is it any good?</button>
                            <br/><br/>
                        </div><!--Get Report-->
                    </div><!--Bottom Row-->
                </div><!--summaryTable-->
                <div class='summaryTable'>
                    <div class='summaryRow'>
                        <div id="report" style='width: 500px; margin: 0 auto;'></div>
                    </div><!--row-->
                    <div class='summaryRow'>

                    </div>
            </div>
            </form>


        </div><!--newFormBox-->





        <!--Content--></div>

    <div id='footer'></div>

    <!--container--></div>

</body>
</html>
